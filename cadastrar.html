<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CtrlWallet - Controle de Despesas</title>
    <link rel="stylesheet" href="style1.css">

</head>

<body>
    <header>
        <h1>CtrlWallet</h1>
        <p class="subtitle">Controle simples de despesas e ganhos</p>
    </header>

    <div class="container">
        <!-- Cards de Totais -->
        <div class="cards-container">
            <div class="card card-ganho">
                <div class="card-label">Ganho Total</div>
                <div class="card-value">R$ 0000.00</div>
                <div class="card-icon">‚Üó</div>
            </div>

            <div class="card card-despesa">
                <div class="card-label">Despesa Total</div>
                <div class="card-value">R$ 0000.00</div>
                <div class="card-icon">‚Üò</div>
            </div>

            <div class="card card-saldo">
                <div class="card-label">Saldo</div>
                <div class="card-value">R$ 0000.00</div>
                <div class="card-icon">üí∞</div>
            </div>
        </div>

        <!-- Se√ß√£o de Formul√°rios -->
        <div class="forms-section">
            <!-- Novo Registro -->
            <div class="form-container">
                <div class="form-header">
                    <h2>Novo Registro</h2>
                    <p>Adicione uma despesa ou ganho</p>
                </div>

                <form id="transactionForm">
                    <div class="tab-buttons">
                        <button type="button" class="tab-btn active" data-type="despesa">Despesa</button>
                        <button type="button" class="tab-btn" data-type="ganho">Ganho</button>
                    </div>

                    <div class="input-group">
                        <input id="valor" placeholder="Valor (R$ 0000.00) " required>
                    </div>

                    <div class="input-group" id="categoriaContainer">
                        <select required>
                            <option value="alimentacao">Alimenta√ß√£o</option>
                            <option value="transporte">Transporte</option>
                            <option value="moradia">Moradia</option>
                            <option value="saude">Sa√∫de</option>
                            <option value="educacao">Educa√ß√£o</option>
                            <option value="lazer">Lazer</option>
                            <option value="utilidades">Utilidades</option>
                            <option value="telefone">Telefone</option>
                            <option value="seguros">Seguros</option>
                            <option value="vestuario">Vestu√°rio</option>
                            <option value="higiene">Higiene Pessoal</option>
                            <option value="pets">Pets</option>
                            <option value="outro">Outro</option>
                        </select>
                    </div>

                    <button type="button" class="btn-submit" onclick="insert()">Adicionar</button>
                </form>
            </div>

            <!-- Nova Meta -->
            <div class="form-container">
                <div class="form-header-meta">
                    <h2>Nova Meta</h2>
                    <p>Defina uma meta financeira</p>
                </div>

                <form id="metaForm">
                    <div class="input-group">
                        <input id="meta" type="text" placeholder="Nome da meta (ex: Viagem, Carro)" required>
                    </div>

                    <div class="input-group">
                        <input id="valormeta" type="text" placeholder="Valor (R$ 0000.00)" required>
                    </div>

                    <div class="input-group">
                        <input id="tempo" type="text" placeholder="Tempo estimado em meses (ex: 10, 20, 30 meses)"
                            required>
                    </div>

                    <button type="button" class="btn-submit-meta" onclick="criarMeta()">Criar Meta</button>
                </form>
            </div>
        </div>

        <!-- Se√ß√£o Principal -->
        <div class="main-section">
            <!-- Minhas Metas -->
            <div class="metas-container">
                <h2>Minhas Metas</h2>
            </div>

            <!-- Dashboard -->
            <div class="dashboard-container">
                <h2>Dashboard - An√°lise por Categoria</h2>
                <p class="dashboard-subtitle">Distribui√ß√£o de Despesas</p>

                <div class="chart-placeholder">
                    <div>
                        <canvas id="myChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


    <script>
        let totalDespesa = 0.0;
        let totalGanho = 0.0;
        let tipoAtual = "despesa";
        let myChart;

        const categorias = {
            alimentacao: 0.0,
            transporte: 0.0,
            moradia: 0.0,
            saude: 0.0,
            educacao: 0.0,
            lazer: 0.0,
            utilidades: 0.0,
            telefone: 0.0,
            seguros: 0.0,
            vestuario: 0.0,
            higiene: 0.0,
            pets: 0.0,
            outro: 0.0
        };

        //criar dashboard
        function criarDashboard() {
            const ctx = document.getElementById('myChart');
            if (myChart) {
                myChart.destroy();
            }
            myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['alimenta√ß√£o', 'transporte', 'moradia', 'saude', 'educa√ß√£o', 'lazer', 'utilidades', 'telefone', 'seguros', 'vestuario', 'higiene', 'pets', 'outro'],
                    datasets: [{
                        label: 'Value',
                        data: [categorias.alimentacao, categorias.transporte, categorias.moradia, categorias.saude, categorias.educacao, categorias.lazer, categorias.utilidades, categorias.telefone, categorias.seguros, categorias.vestuario, categorias.higiene, categorias.pets, categorias.outro],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        criarDashboard();






        // Controle das abas
        const tabButtons = document.querySelectorAll('.tab-btn');
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {

                tabButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');

                tipoAtual = button.dataset.type;

                const categoriaDiv = document.getElementById('categoriaContainer');
                categoriaDiv.style.display = tipoAtual === "ganho" ? "none" : "block";
            });
        });

        // Campo de valor com filtro
        const inputValue = document.getElementById("valor");
        inputValue.addEventListener("input", () => {
            inputValue.value = inputValue.value.replace(/[^\d.,]/g, "");
        });
        const inputValueMeta = document.getElementById("valormeta");
        inputValueMeta.addEventListener("input", () => {
            inputValueMeta.value = inputValueMeta.value.replace(/[^\d.,]/g, "");
        });

        // Fun√ß√£o INSERT
        function insert() {
            const valorInput = document.getElementById("valor");
            const numero = Number(valorInput.value.replace(",", "."));

            if (!numero) {
                alert("Digite um valor v√°lido!");
                return;
            }

            if (tipoAtual === "despesa") {
                const select = document.querySelector('select');
                const categoria = select.value;

                categorias[categoria] += numero;
                totalDespesa += numero;

                document.querySelector('.card-despesa .card-value').textContent =
                    `R$ ${totalDespesa.toFixed(2)}`;
            } else {
                totalGanho += numero;

                document.querySelector('.card-ganho .card-value').textContent =
                    `R$ ${totalGanho.toFixed(2)}`;
            }

            // Atualiza saldo
            const saldo = totalGanho - totalDespesa;
            document.querySelector('.card-saldo .card-value').textContent =
                `R$ ${saldo.toFixed(2)}`;

            valorInput.value = "";
            criarDashboard();
        }

        // Impedir que o formul√°rio recarregue
        document.getElementById('transactionForm').addEventListener('submit', (e) => {
            e.preventDefault();
        });
        document.getElementById('metaForm').addEventListener('submit', (e) => {
            e.preventDefault();
        });


        function criarMeta() {
            // 1. Pegar os elementos e valores
            const metaInput = document.getElementById("meta");
            const metaNome = metaInput.value; // CORRIGIDO: Agora a vari√°vel chama metaNome

            const valorInput = document.getElementById("valormeta");
            // Limpeza robusta do valor (troca v√≠rgula por ponto e remove letras)
            const valorConvertido = Number(valorInput.value.replace(/[^\d,]/g, "").replace(",", "."));

            const tempoInput = document.getElementById("tempo");
            const tempo = Number(tempoInput.value);

            // Valida√ß√£o b√°sica
            if (!metaNome || !valorConvertido || !tempo) {
                alert("Preencha todos os campos corretamente!");
                return;
            }
            if (totalGanho === 0) {
                alert("Adicione pelo menos um ganho antes de criar uma meta!");
                return;
            }

            // 2. Chamada POST para a API
            fetch("https://f0da1d022d81.ngrok-free.app/planejar/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    rendaMensal: String(totalGanho),    // Usando suas vari√°veis globais
                    gastoMensal: String(totalDespesa),  // Usando suas vari√°veis globais
                    montante: String(valorConvertido),
                    tempoMeses: String(tempo)
                })
            })
                .then(response => {
                    if (!response.ok) throw new Error('Erro na requisi√ß√£o');
                    return response.json();
                })
                .then(data => {
                    console.log("Sucesso:", data);

                    // CORRE√á√ÉO: Removemos o alert(data) que mostrava [object Object]

                    // 3. Adicionar o card na tela
                    // Agora passamos 'metaNome' que foi definido l√° em cima
                    adicionarCardNaTela(metaNome, data.dinheiroDisponivel, data.tempoNecessario, valorConvertido);

                    // 4. Limpar campos ap√≥s o sucesso
                    metaInput.value = "";
                    valorInput.value = "";
                    tempoInput.value = "";
                })
                .catch(error => {
                    console.error("Erro:", error);
                    alert("Erro ao conectar com a API. Verifique se o servidor Java est√° rodando.");
                });
        } const metaInput = document.getElementById("meta");


        function adicionarCardNaTela(nome, valorMensalDisponivel, mesesNecessarios, valorTotal) {
            const container = document.querySelector('.metas-container');

            // Cria o HTML do card dinamicamente
            const novoCard = document.createElement('div');
            novoCard.classList.add('meta-card');

            // Formata√ß√µes para moeda
            const valorFormatado = valorMensalDisponivel.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            const totalFormatado = valorTotal.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

            novoCard.innerHTML = `
        <div class="meta-header">
            <span class="meta-name">${nome.toUpperCase()}</span>
            <span style="font-size: 0.8em; color: #666;">Alvo: ${totalFormatado}</span>
        </div>

        <div class="meta-info-row">
            <span class="meta-label">üí∞ Dispon√≠vel/m√™s:</span>
            <span class="meta-value positive">${valorFormatado}</span>
        </div>

        <div class="meta-info-row">
            <span class="meta-label">‚è±Ô∏è Tempo Real Estimado:</span>
            <span class="meta-value" style="color: #2563eb; font-weight: bold;">${mesesNecessarios} meses</span>
        </div>
        
        <button class="btn-generate-chart" onclick="alert('Funcionalidade futura!')">üìä Detalhes</button>
    `;

            // Adiciona o novo card logo ap√≥s o t√≠tulo "Minhas Metas"
            // (Ou use container.appendChild(novoCard) para adicionar no final)
            container.appendChild(novoCard);
        }


        //cria dashboard fora da fun√ß√£o e atualiza dashboard dentro da fun√ß√£o

        // Bot√£o "Adicionar" deve ser type="button"

    </script>
</body>

</html>
